#include <ArduCAM.h>
#include <Wire.h>
#include <SPI.h>

#define CS_PIN 7  // Set your Arducam Chip Select pin
#define CAM_TYPE OV2640  // ArduCAM Model

ArduCAM myCAM(CAM_TYPE, CS_PIN);

void setup() {
  Serial.begin(115200);
  Wire.begin();
  SPI.begin();
  pinMode(CS_PIN, OUTPUT);

  Serial.println("Resetting Arducam...");

  myCAM.write_reg(0x07, 0x80);  // Reset sensor
  delay(100);
  myCAM.write_reg(0x07, 0x00);  // Wake sensor
  delay(100);

  Serial.println("Initializing Camera...");
  myCAM.set_format(JPEG);
  myCAM.InitCAM();
  delay(100);

  myCAM.OV2640_set_JPEG_size(OV2640_320x240);  // Set lower resolution
  delay(100);

  Serial.println("✅ Camera Initialized.");
}


void loop() {
  Serial.println("Flushing FIFO...");
  myCAM.flush_fifo();
  myCAM.clear_fifo_flag();

  Serial.println("Starting capture...");
  myCAM.start_capture();
  delay(500);

  uint8_t fifo_status = myCAM.read_reg(ARDUCHIP_FIFO);
  Serial.print("FIFO Status After Capture: ");
  Serial.println(fifo_status, BIN);

  if (!myCAM.get_bit(ARDUCHIP_TRIG, CAP_DONE_MASK)) {
    Serial.println("❌ Error: Image capture failed.");
    return;
  }

  Serial.println("✅ Image Captured Successfully!");
}
